#!/bin/sh

die() {
	echo $@ >&2
	exit 1
}

if [ -z $ATTIC ]; then
	D=$(pwd)
	while [ -z $ATTIC ] && [ $D != "/" ]; do
		if [ -d $D/attic ]; then
			ATTIC=$D/attic
			REMOTEATTIC=
		elif [ -f $D/.attic ]; then
			ATTIC=$D/.attic-tmp-$$
			REMOTEATTIC=$(cat $D/.attic)
		fi
		D=$(dirname $D)
	done
fi

if [ -z $ATTIC ]; then
	ATTIC=$HOME/attic
fi

[ -d $ATTIC ] || mkdir $ATTIC || die "Failed to mkdir $ATTIC"

while [ -n "$1" ]; do
	CRAP="$1"
	shift

	BOXNAME=$ATTIC/$CRAP
	BOXDIR=$(dirname $BOXNAME)
	[ -d $BOXDIR ] || mkdir -p $BOXDIR || die "Failed to mkdir $BOXDIR"

	if [ -f $CRAP ]; then
		case $CRAP in
			*.gz)
				BOXNAME=$BOXDIR/$(basename $BOXNAME .gz).bz2
				cat $CRAP | gzip -d | bzip2 -c9 > $BOXNAME
				;;
			*.zip)
				BOXNAME=$BOXDIR/$(basename $BOXNAME .zip).tar.bz2
				BOXTEMP=$(tempfile)
				rm -f $BOXTEMP
				mkdir $BOXTEMP
				OLD=$(pwd)
				cd $BOXTEMP

				unzip $OLD/$CRAP && \
				tar -c * | bzip2 -c9 > $BOXNAME
				[ $? -eq 0 ] || die "Failed to repack zip to tar"

				cd $OLD
				rm -rf $BOXTEMP
				;;
			*.bz2)
				;;
			*)
				BOXNAME="$BOXNAME.bz2"
				bzip2 -c9 $CRAP > $BOXNAME
				;;
		esac
	elif [ -d $CRAP ]; then
		if [ -d $CRAP/.git ]; then
			export GIT_DIR=$CRAP/.git
			export GIT_WORK_TREE=$CRAP

			git status | grep 'nothing to commit.*working directory clean' >/dev/null 2>&1 ||
				die "Git working tree in $CRAP is dirty, clean it up"

			git prune
			git repack -adlf

			mkdir $CRAP/.boxit-temp
			BOXNAME="$BOXNAME.git"
			cp -a $GIT_DIR $BOXNAME
			rm -rf $CRAP/.boxit-temp

			export GIT_WORK_TREE=
			export GIT_DIR=
		else
			BOXNAME="$BOXNAME.tar.bz2"
			tar -c $CRAP | bzip2 -c9 > $BOXNAME
		fi
	else
		die "Don't know how to pack $CRAP"
	fi
	if [ -n "$REMOTEATTIC" ]; then
		REMOTEBOX=$REMOTEATTIC/$(basename $BOXNAME)
		scp $BOXNAME $REMOTEBOX
		echo "Packed $CRAP into $REMOTEBOX"
		rm -rf $ATTIC
	else
		echo "Packed $CRAP into $BOXNAME"
	fi
	rm -rf $CRAP
done
