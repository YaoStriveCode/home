#!/bin/sh
# Convenience for communications with Red Tree Systems

DEVDIR=$HOME/redtree
VPNDIR=$DEVDIR/vpn
REPOBASE=https://development.redtreesystems.com/svn
DOMAIN=redtreesystems.com
DEV=development.$DOMAIN

PROXY_BIND=127.0.0.1:8080

RD_OPTS="-r disk:redtree=$HOME/redtree,temp=/tmp"

die() {
	echo $@ >&2
	exit 1
}

vpn_status() {
	VPN_PID=$(cat $VPNDIR/openvpn.pid);

	if [ -z $VPN_PID ]; then
		return 1
	fi

	if kill -0 $VPN_PID >/dev/null 2>&1; then
		return 0
	else
		return 1
	fi
}
cmd_vpn_start() {
	echo -n "Starting vpn: "
	if ! vpn_status; then
		openvpn --cd $VPNDIR --daemon --config client.conf --writepid openvpn.pid
	fi
	echo "done."
}
cmd_vpn_stop() {
	echo -n "Stopping vpn: "
	if vpn_status; then
		kill $VPN_PID
		sleep 2
		if vpn_status; then
			echo -n " SIG9 "
			kill -9 $VPN_PID
		fi
	fi
	echo "done."
}
cmd_vpn_status() {
	if vpn_status; then
		echo "vpn running: [$VPN_PID]"
	else
		echo "vpn not running"
	fi
}

sshscreen () {
  if [ "$TERM" = "screen" ]; then
    screen -t $1 ssh -t $1 screen -D -R -e'^Ee'
  else
    screen -t $1 ssh -t $1 screen -D -R -e'^Uu'
  fi
}

case $1 in
vpn)
	case $2 in
	start)
		cmd_vpn_start
		;;
	stop)
		cmd_vpn_stop
		;;
	status)
		cmd_vpn_status
		;;
	esac
	;;
witch)
  shift
	rdesktop $RD_OPTS $@ witch:3389
	;;
devsh)
	sshscreen $DEV
	;;
svn-clone)
	project=$2
	[ -z "$project" ] &&
		die "Missing project argument"

	cd $DEVDIR
	if [ -d $project ]; then
		mv $project $project.old
	fi

	git svn clone $REPOBASE/$project ||
		die "git svn clone failed"

	cd $project
	git pack

	;;
esac
