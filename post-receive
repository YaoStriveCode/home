#!/usr/bin/python

import gzip
import os
import shlex
import shutil
from subprocess import CalledProcessError, list2cmdline, PIPE, Popen
import sys

notify_to = 'jcorbin@wunjo.org'
puburl = 'http://www.wunjo.org/~jcorbin/forwork'
pubdir = '~/public_html/forwork'
pubdir = os.path.expanduser(pubdir)
pack_template = os.path.join(pubdir, 'pack-{0}-{1}.sh.gz')

def run(cmd, wait=True, ok_retcodes=(0,), **kwargs):
    if isinstance(cmd, unicode):
        cmd = cmd.encode('ascii')
    if isinstance(cmd, str):
        cmdstr = cmd
        cmd = shlex.split(cmd)
    else:
        cmdstr = list2cmdline(cmd)
    p = Popen(cmd, **kwargs)
    p.cmdstr = cmdstr
    p.cmd = cmd
    if wait:
        retcode = p.wait()
        if retcode not in ok_retcodes:
            raise CalledProcessError(retcode, p.cmdstr)
    return p

run_line = lambda cmd, **kwargs: run(
    cmd, stdout=PIPE, **kwargs).stdout.readline().strip()

def revs(*revs):
    cmd = ('git', 'rev-parse') + revs
    for rev in run(cmd, stdout=PIPE).stdout:
        yield rev.strip()

def shortrevs(*rs):
    for rev in revs(*rs):
        yield rev[:7]

def update_file(old, new, repopath, target):
    oldob, newob = revs(
        old + ':' + repopath,
        new + ':' + repopath)
    if oldob == newob: return
    with open(target, 'w') as f:
        show = run(
            ('git', 'show', new + ':' + repopath),
            stdout=PIPE).stdout
        shutil.copyfileobj(show, f)

def read_checkouts(meta_ref):
    path = meta_ref + ':checkouts'
    for i, line in enumerate(run_output(('git', 'show', path))):
        line = line.strip()
        if not line: continue
        try:
            repopath, target = line.split(None, 1)
        except ValueError:
            print >>sys.stderr, \
                'bogus checkouts:{0}: {1}'.format(i+1, line)
        yield repopath, target

def index_contents():
    yield "<!doctype html>\n"
    yield "<html>"
    yield "<head><title>jcorbin home.git shell-pack stage</title></head>"
    yield "<body>"
    yield "<ul>"
    for ent in os.listdir(pubdir):
        if not ent.startswith('pack-'): continue
        yield "<li><a href=\"{0}\">{0}</a></li>".format(ent)
    yield "</ul>"
    yield "</body></html>\n"

if __name__ == '__main__':
    run('git repack -Ad')
    run('git gc')

    meta_ref = 'refs/heads/meta'
    head_ref = run_line('git symbolic-ref HEAD')

    for line in sys.stdin:
        old, new, refname = line.strip().split(None, 2)

        if refname == meta_ref:
            for repopath, target in read_checkouts(meta_ref):
                update_file(old, new, repopath, target)
            continue

        if refname != head_ref: continue

        work, forwork = shortrevs('work/master', 'for/work/master')

        thepack = pack_template.format(work, forwork)

        with gzip.GzipFile(thepack, 'w') as f:
            pack = run('git shell-pack make work', stdout=PIPE).stdout
            shutil.copyfileobj(pack, f)

        with open(os.path.join(pubdir, 'index.html'), 'w') as f:
            for s in index_contents():
                f.write(s)

        if notify_to:
            # TODO: use python module
            mail = run(('mail',
                '--to', notify_to,
                '--subject', os.path.basename(thepack) + ' available'
            ), wait=False, stdin=PIPE)
            mail.stdin.write(puburl + '/' + thepack + '\n')
            mail.stdin.close()
            mail.wait()
