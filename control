#!/bin/sh
# Git based syncing for home data such as dot files

if [ -z $DOTDATADIR ]; then
	if [ -d .git ]; then
		export DOTDATADIR=$(pwd);
	elif [ -d $HOME/dotdata ]; then
		export DOTDATADIR=$HOME/dotdata
	fi
fi

if ! [ -d $DOTDATADIR ]; then
	echo "Could not determine data directory, set DOTDATADIR or execute from within" >&2
	exit 1
fi

chdir $DOTDATADIR

# TODO better etc data handling
# TODO ssh keys
# TODO don't use rsync
case $1 in
	update)
		# Update control util
		cp $0 $HOME/bin/dotdatactl

		# Dot Files
		for ENT in dot/*; do
			HOMEENT=$HOME/.$(echo $ENT | sed -e 's/^dot\///')
			ETCENT=etc/$(basename $ENT)
			echo -n "$HOMEENT: "
			if [ -f $ENT ] && [ -f $ETCENT ]; then
				[ -f $HOMEENT ] && rm -f $HOMEENT >/dev/null
				if cat $ETCENT $ENT >> $HOMEENT; then
					echo "done."
				else
					echo "failed."
				fi
			else
				if rsync -a -q $ENT $HOMEENT; then
					echo "done."
				else
					echo "failed."
				fi
			fi
		done

		;;
	*)
		echo "Missing action to $0" >&2
		exit 1
		;;
esac
